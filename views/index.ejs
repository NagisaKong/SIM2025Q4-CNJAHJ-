<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <!-- 元信息：确保正确编码与响应式展示 -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSR 志愿服务匹配平台控制台</title>
    <!-- 引入简约化样式 -->
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <!-- 顶部栏：显示当前用户信息与注销入口 -->
    <header class="top-bar">
      <div class="top-bar__info">
        <h1>CSR 志愿服务匹配平台</h1>
        <p>当前登录：<strong><%= currentUser.displayName %>（<%= currentUser.role %>）</strong></p>
      </div>
      <form class="top-bar__logout" method="post" action="/logout">
        <button type="submit">注销登录</button>
      </form>
    </header>

    <!-- 全局提示区域：显示成功或错误信息 -->
    <% const flashMessage = typeof flash !== 'undefined' ? flash : null; %>
    <% if (flashMessage) { %>
      <div class="flash flash--<%= flashMessage.type %>">
        <p><%= flashMessage.message %></p>
      </div>
    <% } %>

    <!-- 主内容容器：按照角色职责分块展示 -->
    <main class="content">
      <!-- 概览区：快速理解平台功能 -->
      <section class="section" aria-labelledby="overview-title">
        <h2 id="overview-title">平台概览</h2>
        <p>
          平台集成 CSR 代表、求助者（PIN）、平台管理员与用户管理员的核心操作，支持账号维护、志愿服务匹配与报表洞察。
        </p>
      </section>

      <!-- 用户管理员功能区：仅当角色为管理员时显示操作表单 -->
      <% if (currentUser.role === '用户管理员') { %>
        <section class="section" aria-labelledby="account-admin-title">
          <h2 id="account-admin-title">用户管理员工作台</h2>
          <div class="grid">
            <!-- 创建账户表单 -->
            <form class="card" method="post" action="/admin/accounts/create">
              <h3>创建用户账户</h3>
              <label>用户名
                <input type="text" name="username" placeholder="例如：admin.liang" required />
              </label>
              <label>姓名
                <input type="text" name="displayName" placeholder="请输入姓名" required />
              </label>
              <label>初始密码
                <input type="password" name="password" placeholder="设置登录密码" required />
              </label>
              <label>角色
                <select name="role" required>
                  <% roles.forEach((role) => { %>
                    <option value="<%= role.name %>"><%= role.name %></option>
                  <% }) %>
                </select>
              </label>
              <label>状态
                <select name="status" required>
                  <option value="active">启用</option>
                  <option value="suspended">停用</option>
                </select>
              </label>
              <button type="submit">创建账户</button>
            </form>

            <!-- 创建档案表单 -->
            <form class="card" method="post" action="/admin/profiles/create">
              <h3>创建用户档案</h3>
              <label>档案名称
                <input type="text" name="name" placeholder="例如：CSR 代表" required />
              </label>
              <label>档案描述
                <textarea name="description" rows="3" placeholder="简述职责范围" required></textarea>
              </label>
              <label>权限列表（用逗号分隔）
                <input type="text" name="permissions" placeholder="创建/更新账户, 分配角色权限" />
              </label>
              <button type="submit">创建档案</button>
            </form>
          </div>
        </section>
      <% } %>

      <!-- 账户与档案总览：支持搜索、查看与更新 -->
      <section class="section" aria-labelledby="account-list-title">
        <div class="section__header">
          <h2 id="account-list-title">用户账户总览</h2>
          <form class="inline-form" method="get" action="/dashboard">
            <label for="account-search">关键词查询</label>
            <input
              id="account-search"
              type="search"
              name="accountSearch"
              value="<%= accountKeyword %>"
              placeholder="按用户名、姓名或角色搜索"
            />
            <% if (profileKeyword) { %>
              <input type="hidden" name="profileSearch" value="<%= profileKeyword %>" />
            <% } %>
            <button type="submit">搜索</button>
          </form>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>用户名</th>
                <th>姓名</th>
                <th>角色</th>
                <th>状态</th>
                <th>最近登录</th>
                <% if (currentUser.role === '用户管理员') { %>
                  <th>操作</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% accounts.forEach((account) => { %>
                <tr>
                  <td><%= account.username %></td>
                  <td>
                    <% if (currentUser.role === '用户管理员') { %>
                      <form class="table-form" method="post" action="/admin/accounts/update">
                        <input type="hidden" name="username" value="<%= account.username %>" />
                        <input type="text" name="displayName" value="<%= account.displayName %>" required />
                        <input type="hidden" name="role" value="<%= account.role %>" />
                        <input type="hidden" name="status" value="<%= account.status %>" />
                        <button type="submit">保存姓名</button>
                      </form>
                    <% } else { %>
                      <%= account.displayName %>
                    <% } %>
                  </td>
                  <td>
                    <% if (currentUser.role === '用户管理员') { %>
                      <form class="table-form" method="post" action="/admin/accounts/update">
                        <input type="hidden" name="username" value="<%= account.username %>" />
                        <input type="hidden" name="displayName" value="<%= account.displayName %>" />
                        <select name="role">
                          <% roles.forEach((role) => { %>
                            <option value="<%= role.name %>" <%= account.role === role.name ? 'selected' : '' %>><%= role.name %></option>
                          <% }) %>
                        </select>
                        <input type="hidden" name="status" value="<%= account.status %>" />
                        <button type="submit">保存角色</button>
                      </form>
                    <% } else { %>
                      <%= account.role %>
                    <% } %>
                  </td>
                  <td>
                    <% if (currentUser.role === '用户管理员') { %>
                      <form class="table-form" method="post" action="/admin/accounts/update">
                        <input type="hidden" name="username" value="<%= account.username %>" />
                        <input type="hidden" name="displayName" value="<%= account.displayName %>" />
                        <input type="hidden" name="role" value="<%= account.role %>" />
                        <select name="status">
                          <option value="active" <%= account.status === 'active' ? 'selected' : '' %>>启用</option>
                          <option value="suspended" <%= account.status === 'suspended' ? 'selected' : '' %>>停用</option>
                        </select>
                        <button type="submit">保存状态</button>
                      </form>
                    <% } else { %>
                      <%= account.status === 'active' ? '启用' : '停用' %>
                    <% } %>
                  </td>
                  <td><%= account.lastLogin %></td>
                  <% if (currentUser.role === '用户管理员') { %>
                    <td>
                      <form class="table-form" method="post" action="/admin/accounts/suspend">
                        <input type="hidden" name="username" value="<%= account.username %>" />
                        <button type="submit">暂停账户</button>
                      </form>
                    </td>
                  <% } %>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </section>

      <section class="section" aria-labelledby="profile-list-title">
        <div class="section__header">
          <h2 id="profile-list-title">用户档案总览</h2>
          <form class="inline-form" method="get" action="/dashboard">
            <label for="profile-search">关键词查询</label>
            <input
              id="profile-search"
              type="search"
              name="profileSearch"
              value="<%= profileKeyword %>"
              placeholder="按档案名称或描述搜索"
            />
            <% if (accountKeyword) { %>
              <input type="hidden" name="accountSearch" value="<%= accountKeyword %>" />
            <% } %>
            <button type="submit">搜索</button>
          </form>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>档案名称</th>
                <th>描述</th>
                <th>权限</th>
                <th>状态</th>
                <% if (currentUser.role === '用户管理员') { %>
                  <th>操作</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% profiles.forEach((profile) => { %>
                <tr>
                  <td><%= profile.name %></td>
                  <td>
                    <% if (currentUser.role === '用户管理员') { %>
                      <form class="table-form" method="post" action="/admin/profiles/update">
                        <input type="hidden" name="name" value="<%= profile.name %>" />
                        <textarea name="description" rows="2" required><%= profile.description %></textarea>
                        <input type="hidden" name="status" value="<%= profile.status %>" />
                        <input type="hidden" name="permissions" value="<%= profile.permissions.join(', ') %>" />
                        <button type="submit">保存描述</button>
                      </form>
                    <% } else { %>
                      <%= profile.description %>
                    <% } %>
                  </td>
                  <td>
                    <% if (currentUser.role === '用户管理员') { %>
                      <form class="table-form" method="post" action="/admin/profiles/update">
                        <input type="hidden" name="name" value="<%= profile.name %>" />
                        <input type="hidden" name="description" value="<%= profile.description %>" />
                        <input type="hidden" name="status" value="<%= profile.status %>" />
                        <textarea name="permissions" rows="2"><%= profile.permissions.join(', ') %></textarea>
                        <button type="submit">保存权限</button>
                      </form>
                    <% } else { %>
                      <ul>
                        <% profile.permissions.forEach((item) => { %>
                          <li><%= item %></li>
                        <% }) %>
                      </ul>
                    <% } %>
                  </td>
                  <td>
                    <% if (currentUser.role === '用户管理员') { %>
                      <form class="table-form" method="post" action="/admin/profiles/update">
                        <input type="hidden" name="name" value="<%= profile.name %>" />
                        <input type="hidden" name="description" value="<%= profile.description %>" />
                        <input type="hidden" name="permissions" value="<%= profile.permissions.join(', ') %>" />
                        <select name="status">
                          <option value="active" <%= profile.status === 'active' ? 'selected' : '' %>>启用</option>
                          <option value="suspended" <%= profile.status === 'suspended' ? 'selected' : '' %>>停用</option>
                        </select>
                        <button type="submit">保存状态</button>
                      </form>
                    <% } else { %>
                      <%= profile.status === 'active' ? '启用' : '停用' %>
                    <% } %>
                  </td>
                  <% if (currentUser.role === '用户管理员') { %>
                    <td>
                      <form class="table-form" method="post" action="/admin/profiles/suspend">
                        <input type="hidden" name="name" value="<%= profile.name %>" />
                        <button type="submit">暂停档案</button>
                      </form>
                    </td>
                  <% } %>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </section>

      <!-- CSR 代表视角：展示志愿机会与历史 -->
      <section class="section" aria-labelledby="csr-title">
        <h2 id="csr-title">CSR 志愿服务动态</h2>
        <div class="grid">
          <article class="card">
            <h3>可参与的志愿机会</h3>
            <ul>
              <% volunteerOpportunities.forEach((item) => { %>
                <li>
                  <strong><%= item.title %></strong>｜<%= item.category %>｜<%= item.location %>｜<%= item.schedule %>
                </li>
              <% }) %>
            </ul>
          </article>
          <article class="card">
            <h3>收藏的机会（示例）</h3>
            <ul>
              <% csrShortlist.forEach((item) => { %>
                <li><strong><%= item.title %></strong>｜<%= item.desc %></li>
              <% }) %>
            </ul>
          </article>
          <article class="card">
            <h3>历史服务记录</h3>
            <ul>
              <% csrHistory.forEach((item) => { %>
                <li>
                  <strong><%= item.title %></strong>｜<%= item.category %>｜<%= item.serviceDate %>｜<%= item.duration %>
                </li>
              <% }) %>
            </ul>
          </article>
        </div>
      </section>

      <!-- PIN 视角：展示求助与匹配指标 -->
      <section class="section" aria-labelledby="pin-title">
        <h2 id="pin-title">求助者（PIN）洞察</h2>
        <div class="grid">
          <article class="card">
            <h3>求助请求</h3>
            <ul>
              <% pinRequests.forEach((item) => { %>
                <li>
                  <strong><%= item.title %></strong>｜<%= item.category %>｜状态：<%= requestStatuses[item.status].label %>｜浏览 <%= item.views %> 次｜收藏 <%= item.favorites %> 次
                </li>
              <% }) %>
            </ul>
          </article>
          <article class="card">
            <h3>曝光指标</h3>
            <ul>
              <% pinMetrics.forEach((metric) => { %>
                <li><strong><%= metric.title %></strong>：<%= metric.value %>（<%= metric.description %>）</li>
              <% }) %>
            </ul>
          </article>
          <article class="card">
            <h3>历史匹配</h3>
            <ul>
              <% pinMatches.forEach((match) => { %>
                <li>
                  <strong><%= match.service %></strong>｜CSR：<%= match.csr %>｜完成时间：<%= match.completedAt %>｜反馈：<%= match.feedback %>
                </li>
              <% }) %>
            </ul>
          </article>
        </div>
      </section>

      <!-- 平台管理员视角：管理服务类别与报表 -->
      <section class="section" aria-labelledby="platform-title">
        <h2 id="platform-title">平台运营信息</h2>
        <div class="grid">
          <article class="card">
            <h3>服务类别列表</h3>
            <ul>
              <% serviceCategories.forEach((category) => { %>
                <li><strong><%= category.name %></strong>｜状态：<%= requestStatuses[category.status] ? requestStatuses[category.status].label : category.status %></li>
              <% }) %>
            </ul>
          </article>
          <article class="card">
            <h3>报表摘要</h3>
            <ul>
              <% reports.forEach((report) => { %>
                <li>
                  <strong><%= report.title %></strong>
                  <ul>
                    <% report.highlights.forEach((highlight) => { %>
                      <li><%= highlight %></li>
                    <% }) %>
                  </ul>
                </li>
              <% }) %>
            </ul>
          </article>
        </div>
      </section>
    </main>

    <!-- 页脚：提供版权信息 -->
    <footer class="footer">
      <p>© 2025 CSR 志愿服务匹配平台</p>
    </footer>
  </body>
</html>
